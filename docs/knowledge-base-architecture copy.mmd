---
title: Knowledge Base Architecture - Full Flow
---
flowchart TB
    %% ============================================
    %% INPUT LAYER - Data Sources
    %% ============================================
    subgraph INPUT["üì• INPUT: Data Sources"]
        direction TB
        YAML[".knowledge.yaml<br/>Configuration File"]

        subgraph SOURCES["Source Types"]
            direction LR
            FILES["üìÑ Files<br/>(text, pdf, csv,<br/>json, markdown)"]
            DIR["üìÅ Directory<br/>(glob patterns)"]
            DB["üóÑÔ∏è Database<br/>(SQL query)"]
            WEB["üåê Web<br/>(HTTP scrape)"]
        end
    end

    %% ============================================
    %% ORCHESTRATION LAYER
    %% ============================================
    subgraph MANAGER["üéõÔ∏è KnowledgeStoreManager (Orchestrator)"]
        direction TB
        LOAD_CONFIGS["loadAll()<br/>Discover .knowledge.yaml files"]
        INIT["initialize(name)<br/>Prevent duplicate indexing"]
        METADATA["KnowledgeStoreMetadata<br/>status: not_indexed ‚Üí indexing ‚Üí indexed | error<br/>tracks: docCount, chunkCount, entityCount,<br/>edgeCount, communityCount"]
    end

    %% ============================================
    %% SHARED PIPELINE
    %% ============================================
    subgraph SHARED["üìã Shared Pipeline Steps"]
        direction TB
        LOAD_DOCS["1Ô∏è‚É£ Load Documents<br/>TextLoader | PDFLoader | CSVLoader<br/>JSONLoader | MarkdownLoader<br/>DatabaseLoader | WebLoader"]
        SPLIT["2Ô∏è‚É£ Split into Chunks<br/>CharacterTextSplitter |<br/>RecursiveCharacterTextSplitter<br/>chunkSize (default 1000)<br/>chunkOverlap (default 200)"]
        HASH["3Ô∏è‚É£ Compute Source Hash<br/>SHA-256 of concatenated content"]
    end

    %% ============================================
    %% ROUTING - kind discrimination
    %% ============================================
    ROUTE{"Config kind?"}

    %% ============================================
    %% VECTOR STORE PATH
    %% ============================================
    subgraph VECTOR_PATH["üî∑ Vector Knowledge Store (kind: 'vector')"]
        direction TB

        subgraph VCACHE["Vector Cache Check"]
            VCACHE_CHECK{"Source hash<br/>matches cache?"}
            VCACHE_HIT["‚úÖ Cache HIT<br/>Load pre-computed<br/>embeddings from disk"]
            VCACHE_MISS["‚ùå Cache MISS"]
        end

        EMBED_V["Compute Embeddings<br/>OpenAI-compatible | Gemini | Local<br/>Batch processing"]
        SAVE_VCACHE["Save to .knowledge-cache/{name}/<br/>vectors.bin + metadata.json"]
        MEM_VSTORE["MemoryVectorStore<br/>In-memory cosine similarity<br/>memoryVectors[] array"]
    end

    %% ============================================
    %% GRAPHRAG STORE PATH
    %% ============================================
    subgraph GRAPH_PATH["üî∂ GraphRAG Knowledge Store (kind: 'graph-rag')"]
        direction TB

        subgraph RESTORE["3-Level Restore Strategy"]
            direction TB
            R1{"1. Persistent Store<br/>KB master node exists?"}
            R1_YES["‚úÖ Load all nodes/edges/<br/>communities from store<br/>(Fastest: no re-extraction)"]
            R2{"2. Disk Cache<br/>Valid cached nodes<br/>with embeddings?"}
            R2_YES["‚úÖ Load cached nodes<br/>(Skip extraction,<br/>only rebuild graph)"]
            R3["3. Full Pipeline<br/>(New data or cache miss)"]
        end

        subgraph EXTRACT["üî¨ Extraction Phase"]
            direction TB
            EXTRACT_ROUTE{"extractionMode?"}

            subgraph LLM_MODE["extractionMode: 'llm'"]
                direction TB
                LLM_DESC["EntityExtractor.extractFromChunks()<br/>Sequential chunk processing<br/>(avoids rate limiting)"]
                LLM_PROMPT["Per-chunk LLM Prompt:<br/>‚Ä¢ Entity types to extract<br/>‚Ä¢ Relationship types to extract<br/>‚Ä¢ JSON output schema<br/>‚Ä¢ Deduplication rules<br/>‚Ä¢ 'Extract ALL relationships'"]
                LLM_PARSE["Parse LLM Response ‚Üí JSON<br/>{entities[], relationships[]}"]
                LLM_DEDUP["Deduplication:<br/>Entities: key = name::type (lowercase)<br/>‚Üí keeps longer description, merges chunks<br/>Relationships: key = src‚Üítype‚Üítgt<br/>‚Üí averages weights, keeps longer desc"]
            end

            subgraph DIRECT_MODE["extractionMode: 'direct'"]
                direction TB
                DIRECT_DESC["DirectMapper.mapQueryResults()<br/>Maps SQL rows directly to graph<br/>100% data preservation guaranteed"]
                DIRECT_CONF["Configuration:<br/>entities:<br/>  - type, idColumn, nameColumn,<br/>    properties<br/>relationships:<br/>  - type, source, target,<br/>    sourceIdColumn, targetIdColumn"]
                DIRECT_PROC["Processing:<br/>For each document row:<br/>‚Üí Extract entities per mapping<br/>‚Üí Deduplicate by type::id<br/>‚Üí Link relationships"]
            end
        end

        subgraph BUILD["üèóÔ∏è Graph Construction"]
            direction TB
            EMBED_E["Embed Entity Descriptions<br/>Generate embedding vectors<br/>for all entities"]
            CREATE_NODES["Create GraphNodes<br/>id = 'type::name' (normalized)<br/>+ embedding, description,<br/>properties, sourceChunkIds"]
            CREATE_EDGES["Create GraphEdges<br/>sourceId, targetId, type,<br/>weight (0.0-1.0), description"]
            KB_NODE["Add KB Master Node<br/>+ BELONGS_TO_KB edges<br/>(links all entities to KB)"]
            GRAPH_STORE["MemoryGraphStore<br/>(graphology-based)<br/>In-memory graph instance"]
        end

        subgraph COMMUNITY["üèòÔ∏è Community Detection & Summarization"]
            direction TB
            DETECT["CommunityDetector.detect()<br/>Algorithm: Louvain<br/>‚Ä¢ Convert directed ‚Üí undirected<br/>‚Ä¢ Merge parallel edges (sum weights)<br/>‚Ä¢ Config: resolution (1.0), minSize (2)"]

            subgraph SUMMARIZE["CommunitySummarizer.summarize()"]
                direction TB
                SUMM_DESC["For each community:"]
                SUMM_GATHER["1. Gather all nodes in community<br/>2. Get all internal edges"]
                SUMM_FORMAT["3. Format context:<br/>Entity list + Relationship list"]
                SUMM_LLM["4. LLM Prompt:<br/>'Analyze this community structure'"]
                SUMM_OUT["5. Output JSON:<br/>title (5-10 words)<br/>summary (2-4 sentences)"]
            end
        end

        SAVE_GCACHE["Save to Extraction Cache<br/>.graph-cache/{name}/<br/>cache-metadata.json<br/>entities.json<br/>relationships.json<br/>communities.json<br/>nodes.json (with embeddings)"]
    end

    %% ============================================
    %% OUTPUT LAYER - Search Strategies
    %% ============================================
    subgraph OUTPUT["üì§ OUTPUT: Knowledge Retrieval"]
        direction TB

        subgraph VSEARCH["Vector Search"]
            VS_FLOW["Query ‚Üí Embed ‚Üí Cosine Similarity<br/>‚Üí Top-K results<br/>Optional: scoreThreshold filter"]
        end

        subgraph GSEARCH["GraphRAG Search"]
            direction TB
            MODE_DETECT["SearchModeDetector (Heuristic)<br/>GLOBAL indicators: 'overall', 'themes',<br/>'patterns', 'summarize', 'trends'<br/>LOCAL indicators: 'who', 'which',<br/>'tell me about', 'specific', 'details'<br/>Proper nouns/quotes ‚Üí +2 local"]

            SEARCH_ROUTE{"Detected mode?"}

            subgraph LOCAL["üîç Local Search (Entity-Neighborhood)"]
                direction TB
                LS1["1. Embed query"]
                LS2["2. Find top-K similar entities<br/>(cosine similarity on embeddings)"]
                LS3["3. For each top entity:<br/>BFS expand to maxDepth hops"]
                LS4["4. Collect nodes + edges in neighborhood"]
                LS5["5. Format: Entity + Relationships<br/>+ Connected Entities"]
                LS6["6. Score = cosine(query, entity)<br/>Return sorted top-K"]
            end

            subgraph GLOBAL["üåê Global Search (Community Map-Reduce)"]
                direction TB
                GS_MAP["MAP Phase:<br/>1. Get all communities<br/>2. Sort by size desc, take top-N<br/>3. For each community with summary:<br/>   LLM: 'Answer query using<br/>   this community summary'<br/>4. Extract partial answers"]
                GS_REDUCE["REDUCE Phase:<br/>1. Gather all partial answers<br/>2. LLM: 'Synthesize into<br/>   comprehensive answer'<br/>3. Remove redundancies<br/>4. Return single SearchResult"]
            end
        end

        subgraph TOOLS["üîß Knowledge Tools (Agent Interface)"]
            direction LR
            T_SEARCH["search<br/>(both modes)"]
            T_TRAVERSE["traverse<br/>(graph-rag)"]
            T_ENTITY["entity_lookup<br/>(graph-rag)"]
            T_SCHEMA["graph_schema<br/>(graph-rag)"]
            T_CYPHER["cypher query<br/>(graph-rag)"]
            T_SQL["sql query<br/>(database source)"]
        end

        AGENT["ü§ñ AI Agent<br/>Uses tools to query<br/>knowledge stores"]
    end

    %% ============================================
    %% CONNECTIONS
    %% ============================================

    %% Input to Manager
    YAML --> LOAD_CONFIGS
    SOURCES --> LOAD_DOCS
    LOAD_CONFIGS --> INIT
    INIT --> METADATA

    %% Manager to Shared Pipeline
    INIT --> LOAD_DOCS
    LOAD_DOCS --> SPLIT
    SPLIT --> HASH
    HASH --> ROUTE

    %% Routing
    ROUTE -->|"kind: 'vector'"| VCACHE_CHECK
    ROUTE -->|"kind: 'graph-rag'"| R1

    %% Vector Path
    VCACHE_CHECK -->|"yes"| VCACHE_HIT
    VCACHE_CHECK -->|"no"| VCACHE_MISS
    VCACHE_HIT --> MEM_VSTORE
    VCACHE_MISS --> EMBED_V
    EMBED_V --> SAVE_VCACHE
    SAVE_VCACHE --> MEM_VSTORE
    MEM_VSTORE --> VS_FLOW

    %% GraphRAG Restore
    R1 -->|"yes"| R1_YES
    R1 -->|"no"| R2
    R2 -->|"yes"| R2_YES
    R2 -->|"no"| R3
    R1_YES --> MODE_DETECT
    R2_YES --> BUILD
    R3 --> EXTRACT_ROUTE

    %% Extraction Routing
    EXTRACT_ROUTE -->|"'llm'"| LLM_DESC
    EXTRACT_ROUTE -->|"'direct'"| DIRECT_DESC
    LLM_DESC --> LLM_PROMPT --> LLM_PARSE --> LLM_DEDUP
    DIRECT_DESC --> DIRECT_CONF --> DIRECT_PROC
    LLM_DEDUP --> BUILD
    DIRECT_PROC --> BUILD

    %% Graph Construction
    EMBED_E --> CREATE_NODES --> CREATE_EDGES --> KB_NODE --> GRAPH_STORE

    %% Community
    GRAPH_STORE --> DETECT
    DETECT --> SUMM_DESC
    SUMM_DESC --> SUMM_GATHER --> SUMM_FORMAT --> SUMM_LLM --> SUMM_OUT

    %% Cache
    SUMM_OUT --> SAVE_GCACHE

    %% Search
    SAVE_GCACHE --> MODE_DETECT
    MODE_DETECT --> SEARCH_ROUTE
    SEARCH_ROUTE -->|"local"| LS1
    SEARCH_ROUTE -->|"global"| GS_MAP
    LS1 --> LS2 --> LS3 --> LS4 --> LS5 --> LS6
    GS_MAP --> GS_REDUCE

    %% Tools
    VS_FLOW --> T_SEARCH
    LS6 --> T_SEARCH
    LS6 --> T_TRAVERSE
    LS6 --> T_ENTITY
    GS_REDUCE --> T_SEARCH
    GRAPH_STORE --> T_SCHEMA
    GRAPH_STORE --> T_CYPHER
    DB --> T_SQL
    T_SEARCH --> AGENT
    T_TRAVERSE --> AGENT
    T_ENTITY --> AGENT
    T_SCHEMA --> AGENT
    T_CYPHER --> AGENT
    T_SQL --> AGENT

    %% ============================================
    %% STYLING
    %% ============================================
    classDef inputStyle fill:#E3F2FD,stroke:#1565C0,stroke-width:2px,color:#0D47A1
    classDef managerStyle fill:#FFF3E0,stroke:#E65100,stroke-width:2px,color:#BF360C
    classDef sharedStyle fill:#F3E5F5,stroke:#6A1B9A,stroke-width:2px,color:#4A148C
    classDef vectorStyle fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px,color:#1B5E20
    classDef graphStyle fill:#FFF8E1,stroke:#F9A825,stroke-width:2px,color:#F57F17
    classDef extractStyle fill:#FCE4EC,stroke:#C62828,stroke-width:2px,color:#B71C1C
    classDef communityStyle fill:#E0F7FA,stroke:#00838F,stroke-width:2px,color:#006064
    classDef searchStyle fill:#EDE7F6,stroke:#4527A0,stroke-width:2px,color:#311B92
    classDef toolStyle fill:#EFEBE9,stroke:#4E342E,stroke-width:2px,color:#3E2723
    classDef routeStyle fill:#FFECB3,stroke:#FF6F00,stroke-width:3px,color:#E65100
    classDef cacheStyle fill:#E8EAF6,stroke:#283593,stroke-width:2px,color:#1A237E

    class YAML,FILES,DIR,DB,WEB inputStyle
    class LOAD_CONFIGS,INIT,METADATA managerStyle
    class LOAD_DOCS,SPLIT,HASH sharedStyle
    class ROUTE,EXTRACT_ROUTE,SEARCH_ROUTE,VCACHE_CHECK,R1,R2 routeStyle
    class EMBED_V,SAVE_VCACHE,MEM_VSTORE,VCACHE_HIT,VCACHE_MISS vectorStyle
    class LLM_DESC,LLM_PROMPT,LLM_PARSE,LLM_DEDUP extractStyle
    class DIRECT_DESC,DIRECT_CONF,DIRECT_PROC extractStyle
    class EMBED_E,CREATE_NODES,CREATE_EDGES,KB_NODE,GRAPH_STORE graphStyle
    class DETECT,SUMM_DESC,SUMM_GATHER,SUMM_FORMAT,SUMM_LLM,SUMM_OUT communityStyle
    class SAVE_GCACHE,R1_YES,R2_YES,R3 cacheStyle
    class MODE_DETECT,VS_FLOW,LS1,LS2,LS3,LS4,LS5,LS6,GS_MAP,GS_REDUCE searchStyle
    class T_SEARCH,T_TRAVERSE,T_ENTITY,T_SCHEMA,T_CYPHER,T_SQL,AGENT toolStyle
